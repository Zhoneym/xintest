name: Build PHP 8.4.8 using ARM64 container

on:
  workflow_dispatch:

jobs:
  build-php:
    runs-on: ubuntu-latest

    steps:
      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v2
        with:
          platforms: arm64

      - name: Build inside ARM64 Ubuntu container
        uses: docker://arm64v8/ubuntu:20.04
        with:
          options: --cpus 2
        run: |
          export DEBIAN_FRONTEND=noninteractive
          export TZ=Etc/UTC
          apt-get update && apt-get install -y \
            build-essential autoconf bison re2c curl \
            libxml2-dev libsqlite3-dev libcurl4-openssl-dev libjpeg-dev \
            libpng-dev libwebp-dev libfreetype6-dev libzip-dev libonig-dev \
            libssl-dev libreadline-dev pkg-config libmysqlclient-dev \
            libxslt1-dev libpq-dev libicu-dev file curl

          curl -sSL https://www.php.net/distributions/php-8.4.8.tar.gz | tar -xz

          cd php-8.4.8
          ./buildconf --force
          ./configure --prefix=/php-8.4.8 \
            --with-config-file-path=/php-8.4.8/etc \
            --enable-fpm \
            --with-fpm-user=www-data \
            --with-fpm-group=www-data \
            --enable-mbstring \
            --enable-mysqlnd \
            --with-curl \
            --with-openssl \
            --with-zlib \
            --with-pdo-mysql \
            --enable-soap \
            --enable-intl \
            --with-xsl \
            --enable-bcmath \
            --with-gettext \
            --with-readline

          make -j$(nproc)
